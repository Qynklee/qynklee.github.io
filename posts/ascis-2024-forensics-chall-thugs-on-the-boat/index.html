<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ASCIS 2024 Forensics Chall: Thugs on the boat | Qynklee in the wild</title>
<meta name="keywords" content="RE, Forensics, CTF">
<meta name="description" content="Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman

Chall cho ta 2 file:

file process dump
file pcapng lưu lượng mạng

1. Kiểm tra file process dump
Load vào windbg
Dùng command lm để check các module:

Nhận thấy chỉ có module OneDrive là không có symbols.
Kiểm tra module này, bằng lệnh lmDvmOneDrive

Thấy file thực thi được tải về từ Internet tại Downloads.">
<meta name="author" content="Qynklee">
<link rel="canonical" href="https://qynklee.github.io/posts/ascis-2024-forensics-chall-thugs-on-the-boat/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://qynklee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://qynklee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://qynklee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://qynklee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://qynklee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://qynklee.github.io/posts/ascis-2024-forensics-chall-thugs-on-the-boat/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://qynklee.github.io/posts/ascis-2024-forensics-chall-thugs-on-the-boat/">
  <meta property="og:site_name" content="Qynklee in the wild">
  <meta property="og:title" content="ASCIS 2024 Forensics Chall: Thugs on the boat">
  <meta property="og:description" content="Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman
Chall cho ta 2 file:
file process dump file pcapng lưu lượng mạng 1. Kiểm tra file process dump Load vào windbg
Dùng command lm để check các module:
Nhận thấy chỉ có module OneDrive là không có symbols.
Kiểm tra module này, bằng lệnh lmDvmOneDrive
Thấy file thực thi được tải về từ Internet tại Downloads.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-03T16:14:06+07:00">
    <meta property="article:modified_time" content="2025-08-03T16:14:06+07:00">
    <meta property="article:tag" content="RE">
    <meta property="article:tag" content="Forensics">
    <meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ASCIS 2024 Forensics Chall: Thugs on the boat">
<meta name="twitter:description" content="Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman

Chall cho ta 2 file:

file process dump
file pcapng lưu lượng mạng

1. Kiểm tra file process dump
Load vào windbg
Dùng command lm để check các module:

Nhận thấy chỉ có module OneDrive là không có symbols.
Kiểm tra module này, bằng lệnh lmDvmOneDrive

Thấy file thực thi được tải về từ Internet tại Downloads.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://qynklee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ASCIS 2024 Forensics Chall: Thugs on the boat",
      "item": "https://qynklee.github.io/posts/ascis-2024-forensics-chall-thugs-on-the-boat/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASCIS 2024 Forensics Chall: Thugs on the boat",
  "name": "ASCIS 2024 Forensics Chall: Thugs on the boat",
  "description": "Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman\nChall cho ta 2 file:\nfile process dump file pcapng lưu lượng mạng 1. Kiểm tra file process dump Load vào windbg\nDùng command lm để check các module:\nNhận thấy chỉ có module OneDrive là không có symbols.\nKiểm tra module này, bằng lệnh lmDvmOneDrive\nThấy file thực thi được tải về từ Internet tại Downloads.\n",
  "keywords": [
    "RE", "Forensics", "CTF"
  ],
  "articleBody": "Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman\nChall cho ta 2 file:\nfile process dump file pcapng lưu lượng mạng 1. Kiểm tra file process dump Load vào windbg\nDùng command lm để check các module:\nNhận thấy chỉ có module OneDrive là không có symbols.\nKiểm tra module này, bằng lệnh lmDvmOneDrive\nThấy file thực thi được tải về từ Internet tại Downloads.\nĐịa chỉ trong memory từ 0x7ff620ae0000 đến 0x7ff620afe000\nthực hiện dump đoạn memory này ra file bằng lệnh\n.writemem C:\\TEMP\\OneDrive.dmp 00007ff6`20ae0000 00007ff6`20afe000 Tuy nhiên, báo lỗi không access được dữ liệu tại 0x7ff620afe000\nMình mới thực hiện phân tích lại !analyze -v (không cần thiết)\nSau đó chỉ dump đến 0x7ff620afdf00, bỏ 0x100 bytes cuối đi (đoán)\n.writemem C:\\TEMP\\OneDrive.dmp 00007ff6`20ae0000 00007ff6`20afdf00 Thì dump thành công, Windows Defender check và báo mã độc Havoc.C\nTìm kiếm một hồi về các bài phân tích Havoc C2, mình tìm được 2 link này:\nhttps://github.com/Immersive-Labs-Sec/HavocC2-Forensics\nhttps://www.immersivelabs.com/blog/havoc-c2-framework-a-defensive-operators-guide/\nvà link tàu này:\nhttps://www.51cto.com/article/767998.html\n(Có sẵn PDF cùng folder)\nPhát hiện, cấu trúc KEY_MAKER của Havoc C2 như sau:\nsignatures = { 'havoc_key_marker': \"\"\"rule havoc_aes_marker { strings: $AES_KEY_MARKER = { 00 00 ?? ?? de ad be ef ?? ?? ?? ?? 00 00 00 63 00 00 00 00 } condition: $AES_KEY_MARKER }\"\"\" } Đoạn code detect AES Key và IV, agent ID như sau:\nrules = yara.compile(sources = signatures) .... for offset, rule_name, _name, _value in layer.scan(context = self.context, scanner = yarascan.YaraScanner(rules = rules), sections = vadyarascan.VadYaraScan.get_vad_maps(proc)): if rule_name == 'havoc_aes_marker': # Read 1024 bytes from the layer at the offset and try to parse out some values. raw_data = layer.read(offset, 1024, False) vollog.debug(f'Found AES Key Marker at {hex(offset)} in {process_name}\\n') vollog.debug(f'Raw Data: {raw_data}\\n') agent_id = raw_data[8:12].hex() vollog.debug(f'Agent ID: {agent_id}\\n') aes_key = raw_data[20:52].hex() vollog.debug(f'AES Key: {aes_key}\\n') aes_iv = raw_data[52:68].hex() vollog.debug(f'AES IV: {aes_iv}\\n') Có thể thấy AES Key ở offset [20:52], AES IV ở offset [52:68] và Agent ID ở [8:12] tại vị trí tìm ra signature.\nDo đó, mình nhanh chóng thu được key, iv và agent id từ file dump process.\nNhư vậy:\nThu được:\nagent id: 2a c0 84 1e aes key: [20:52] D4 DC 20 98 7E EC 20 02 E0 46 D0 D0 3C BC C2 9A 88 96 44 34 D0 42 90 12 66 BA 98 1C E0 48 98 1E aes iv: [52:68] DC DA C0 90 F6 5E A6 76 FC 72 8E 08 54 66 40 30 Như vậy, mình đã nghĩ đến đây là xong. Mình chỉ mất khoảng 1 tiếng để tìm được đến đây.\nVới bài phân tích vừa rồi, mình đoán sẽ dùng AES decrypt giải mã pcapng để lấy flag.\nTuy nhiên, mọi chuyện không như là mơ.\n2. Xử lý pcapng Kiểm tra pcapng thì chỉ thấy có 2 IP 192.168.240.148 và 192.168.240.147.\nKiểm tra thì chỉ có 2 tcpstream là 0 và 1. là các request đến cổng 443 của IP:148. (attacker)\nNhư vậy, mình cần tìm các requests gửi dữ liệu lên máy chủ, decrypt là lấy được file.\nKhó khăn từ đây (do mình dốt crypto :\u003c)\nKiểm tra sơ sơ thì thấy có vài request POST send data rất lớn.\nĐến đây mình dùng Cyberchef để cố decrypt phần body request nhưng thử với tất cả các thuật toán đều không được, về sau phát hiện ra, Havoc dùng AES CTR mode.\nTuy nhiên, mình vẫn không decrypt được, mình có thử viết code python decrypt cũng không được. Mãi sau, mình mới đọc lại blog 51cto ở trên. Phát hiện phần body có cấu trúc. 20bytes đầu là các giá trị, sau đó là data bị mã hoá.\nData POST lên có cấu trúc như sau:\nDó, lúc này mình mới nhận ra và bắt đầu đi lọc các POST request lớn, có Agent ID và check dữ liệu decrypt.\nMình thu được output command, khẳng định AES Key IV là đúng\nSau đó mình tìm thấy một request có data decrypt có thứ rất quen thuộc, .rels và .xml. Với bản năng của 1 mal analysis, đây là docx mình cần!!!\nMình thu được file docx sau khi chạy word recovery.\nflag 2:\nFlag2: Th3_9r0unD_0b3y5_m3_0e2845b20c93546} Mình bắt đầu hơi hụt hẫng, ủa flag1 đâu, hay trong request vẫn còn. Mình tiếp tục đi decrypt hết các POST data, thậm chí cả data trả về của Havoc C2 server ở IP:148.\nThu được, đoạn text flagpart1 ????\nHay một số data có cấu trúc rất lạ, giống kiểu output của ascii graphic, mà mình không đoán ra ý nghĩa\nData ec0 ec1 do server gửi đến\nNohope flag part 1 :\u003c\nSau đó team có tìm thêm 1 số string trong file OneDrive.exe\nNhưng có vẻ không khả quan lắm.\nCuối cùng mình định tạo lại lab Havoc nhưng đã quá muộn.\nEND GAME lần xxx :((((\nBonus, phần flagpart1, sau khi có WU của tác giả\nĐúng như dự đoán, phần dữ liệu được server gửi đến máy nạn nhân sẽ là 1 object BOF để thực thi,\nHãy quan sát 1 response\nNhư trên, khi server response theo cấu trúc chunk, ta sẽ chỉ quan tâm phần Chunk data.\nphần Chunk Data này sẽ cấu trúc như sau:\n12 bytes đầu (HEADER) | Sau là data Trong HEADER: 2 bytes đầu là Command ID (ở Little edians) =\u003e 0x0A00 = 2560 =\u003e BOF objects Như vậy, decrypt ra sẽ được BOF object.\nTuy nhiên, BOF có signature là bắt đầu bằng bytes\n0x64 0x86 cho 64 bit và 0x4C 0x01 (chữ dt và L.) như ảnh (Phần File Header của NTHeader)\nvới 32bit\nThì trong BOF sẽ như này\nNém vào IDA, phân tích, bấm mặc định, nó sẽ ra được\nNhư vậy, sau khi decrypt BOF bằng AES-CTR mode, ta sẽ phải xoá đi 16bytes đầu để bắt đầu bằng signature BOF.\nKiểm tra hết các BOF, thấy có BOF để thực thi adduser mà không cần dùng command adduser của windows. Đó là user flagpart1\nVì vậy, ta cần đi tìm data của câu lệnh này ở đâu trong BOF object này.\nPhần ảo: Tìm data của BOF object này Theo cấu trúc của havoc C2 BOF, thì các BOF sẽ được tạo sẵn , phần data sẽ nối ở phía sau BOF.\nNhưng các thức chúng được mã hoá AES lại khác nhau\nnhư sau:\nDataChunk = 12bytes HEADER + AES-CTF_Encrypt( 16bytes + BOF object ) + DATA_sau_BOF Mở rộng nhanh, thực tế phần data sau BOF object có 12 bytes là: TaskID, Command,Executable, packed data length nên: DATA_sau_BOF = 12 bytes + AES-CTF_Encrypt( Dữ liệu parametter của BOF ) Nghĩa phần data được mã hoá riêng rẽ chứ không mã hoá chung 1 lần với BOF object.\nMà AES-CTR mode sẽ mã hoá 1bytes thành 1 bytes (tương đương)\nNên chỉ cần lấy độ dài dữ liệu của data chunk post - độ dài BOF objects sau giải mã - 16bytes đầu\nsẽ ra được độ dài phần data bị mã hoá.\nVậy làm sao biết đc BOF object dài bao nhiêu.\nhttps://github.com/HavocFramework/Modules/blob/main/RemoteOps/bin/adduser.x64.o\nCác BOF object là pre-built\nVì vậy, chỉ cần tải file adduser.x64.o cho khớp với BOF trong decrypted data, ta sẽ có được length.\nỞ đây, object BOF Adduser kết thúc ở length 3583, tận cùng là byte 0x00\nVì vậy, với phần data encrypted ở Data chunk\nPhần này cấu trúc như đã nói, toàn bộ Data Chunk có length 3776.\nXoá 12bytes đầu header Được BOF encrypted + data encrypted Tuy nhiên BOF encrypted này có chứa 16bytes đầu là bytes gì đó, trước khi đến được đoạn signature BOF.\nXoá 16bytes đầu của BOF để ra đc signature dt\nXoá tiếp 3583 bytes BOF object\nTa thu được phần data BOF encrypted.\nTuy nhiên, phần data BOF encrypted này cũng có cấu trúc là 12 bytes: TaskID, Command,Executable, packed data length rồi mới đến AES-CTR_Encrypted(Data của BOF)\nXoá 12 bytes đầu\nThực hiện decrypt AES-CTR, Decode UTF-16 LE\nThu được đoạn bytes (153 bytes):\n3b 53 9a a6 93 b6 31 3a cf 25 d6 fa bd b3 ac 98 69 84 ad 7b 25 94 0e ab 5c 3c ec 4b da ea 98 e8 5e b5 c2 5a 8e 37 fa f8 83 eb c4 34 c4 d2 9c e0 67 a6 b5 c0 a3 98 57 3e 29 35 f9 aa 5d 25 1d 44 4d 3e 8d 15 f8 a0 ba 5b 12 a5 55 55 f4 d9 d4 85 b7 f4 1d 6d 8d 7b 4a b9 b0 ca 3e 4d 7b 45 75 4d ff fd 43 74 34 28 b9 d4 3e 14 1b b3 df 7b b6 7a 3c 86 23 7f 82 12 04 a7 5e 62 14 00 00 00 13 d0 c5 8f 13 00 00 00 64 09 97 a7 9e d9 31 8d f7 fd 4d a6 8d be ad 98 0f 84 ad Decrypt bằng AES-CTR và Decode UTF-16 LE:\nVậy flag1 :\nASCIS{C@nt_k3Ep_m3_1n_7hE_9r0uNd_ ",
  "wordCount" : "1503",
  "inLanguage": "en",
  "datePublished": "2025-08-03T16:14:06+07:00",
  "dateModified": "2025-08-03T16:14:06+07:00",
  "author":{
    "@type": "Person",
    "name": "Qynklee"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://qynklee.github.io/posts/ascis-2024-forensics-chall-thugs-on-the-boat/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Qynklee in the wild",
    "logo": {
      "@type": "ImageObject",
      "url": "https://qynklee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://qynklee.github.io/" accesskey="h" title="Qynklee in the wild (Alt + H)">Qynklee in the wild</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://qynklee.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://qynklee.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://qynklee.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://qynklee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://qynklee.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://qynklee.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ASCIS 2024 Forensics Chall: Thugs on the boat
    </h1>
    <div class="post-meta"><span title='2025-08-03 16:14:06 +0700 +07'>August 3, 2025</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1503 words&nbsp;·&nbsp;Qynklee

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-ki%e1%bb%83m-tra-file-process-dump" aria-label="1. Kiểm tra file process dump">1. Kiểm tra file process dump</a></li>
                <li>
                    <a href="#2-x%e1%bb%ad-l%c3%bd-pcapng" aria-label="2. Xử lý pcapng">2. Xử lý pcapng</a><ul>
                        
                <li>
                    <a href="#ph%e1%ba%a7n-%e1%ba%a3o-t%c3%acm-data-c%e1%bb%a7a-bof-object-n%c3%a0y" aria-label="Phần ảo: Tìm data của BOF object này">Phần ảo: Tìm data của BOF object này</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Dưới đây là chall Forensic của SVATTT 2024. Tác giả: bquanman</p>
<p><img alt="image-20241019215932448" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019215932448.png"></p>
<p>Chall cho ta 2 file:</p>
<ul>
<li>file process dump</li>
<li>file pcapng lưu lượng mạng</li>
</ul>
<h4 id="1-kiểm-tra-file-process-dump">1. Kiểm tra file process dump<a hidden class="anchor" aria-hidden="true" href="#1-kiểm-tra-file-process-dump">#</a></h4>
<p>Load vào windbg</p>
<p>Dùng command <code>lm</code> để check các module:</p>
<p><img alt="image-20241019220138144" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019220138144.png"></p>
<p>Nhận thấy chỉ có module OneDrive là không có symbols.</p>
<p>Kiểm tra module này, bằng lệnh <code>lmDvmOneDrive</code></p>
<p><img alt="image-20241019220239946" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019220239946.png"></p>
<p>Thấy file thực thi được tải về từ Internet tại Downloads.</p>
<p>Địa chỉ trong memory từ <code>0x7ff620ae0000</code> đến <code>0x7ff620afe000</code></p>
<p>thực hiện dump đoạn memory này ra file bằng lệnh</p>
<pre tabindex="0"><code>.writemem C:\TEMP\OneDrive.dmp 00007ff6`20ae0000 00007ff6`20afe000
</code></pre><p>Tuy nhiên, báo lỗi không access được dữ liệu tại 0x7ff620afe000</p>
<p><img alt="image-20241019220535183" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019220535183.png"></p>
<p>Mình mới thực hiện phân tích lại <code>!analyze -v</code> (không cần thiết)</p>
<p>Sau đó chỉ dump đến 0x7ff620afdf00, bỏ 0x100 bytes cuối đi (đoán)</p>
<pre tabindex="0"><code>.writemem C:\TEMP\OneDrive.dmp 00007ff6`20ae0000 00007ff6`20afdf00
</code></pre><p>Thì dump thành công, Windows Defender check và báo mã độc <code>Havoc.C</code></p>
<p><img alt="image-20241019220802676" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019220802676.png"></p>
<p>Tìm kiếm một hồi về các bài phân tích Havoc C2, mình tìm được 2 link này:</p>
<p><a href="https://github.com/Immersive-Labs-Sec/HavocC2-Forensics">https://github.com/Immersive-Labs-Sec/HavocC2-Forensics</a></p>
<p><a href="https://www.immersivelabs.com/blog/havoc-c2-framework-a-defensive-operators-guide/">https://www.immersivelabs.com/blog/havoc-c2-framework-a-defensive-operators-guide/</a></p>
<p>và link tàu này:</p>
<p><a href="https://www.51cto.com/article/767998.html">https://www.51cto.com/article/767998.html</a></p>
<p>(Có sẵn PDF cùng folder)</p>
<p>Phát hiện,  cấu trúc KEY_MAKER của Havoc C2 như sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>signatures <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;havoc_key_marker&#39;</span>: <span style="color:#e6db74">&#34;&#34;&#34;rule havoc_aes_marker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                strings:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                  $AES_KEY_MARKER = { 00 00 ?? ?? de ad be ef ?? ?? ?? ?? 00 00 00 63 00 00 00 00 }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                condition:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                  $AES_KEY_MARKER
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                }&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn code detect AES Key và IV, agent ID như sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span> rules <span style="color:#f92672">=</span> yara<span style="color:#f92672">.</span>compile(sources <span style="color:#f92672">=</span> signatures)
</span></span><span style="display:flex;"><span> <span style="color:#f92672">....</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> offset, rule_name, _name, _value <span style="color:#f92672">in</span> layer<span style="color:#f92672">.</span>scan(context <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>context,
</span></span><span style="display:flex;"><span>                                                             scanner <span style="color:#f92672">=</span> yarascan<span style="color:#f92672">.</span>YaraScanner(rules <span style="color:#f92672">=</span> rules),
</span></span><span style="display:flex;"><span>                                                             sections <span style="color:#f92672">=</span> vadyarascan<span style="color:#f92672">.</span>VadYaraScan<span style="color:#f92672">.</span>get_vad_maps(proc)):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> rule_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;havoc_aes_marker&#39;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># Read 1024 bytes from the layer at the offset and try to parse out some values. </span>
</span></span><span style="display:flex;"><span>                    raw_data <span style="color:#f92672">=</span> layer<span style="color:#f92672">.</span>read(offset, <span style="color:#ae81ff">1024</span>, <span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>                    vollog<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Found AES Key Marker at </span><span style="color:#e6db74">{</span>hex(offset)<span style="color:#e6db74">}</span><span style="color:#e6db74"> in </span><span style="color:#e6db74">{</span>process_name<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                    vollog<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Raw Data: </span><span style="color:#e6db74">{</span>raw_data<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    agent_id <span style="color:#f92672">=</span> raw_data[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">12</span>]<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>                    vollog<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Agent ID: </span><span style="color:#e6db74">{</span>agent_id<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                    aes_key <span style="color:#f92672">=</span> raw_data[<span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">52</span>]<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>                    vollog<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;AES Key: </span><span style="color:#e6db74">{</span>aes_key<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>                    aes_iv <span style="color:#f92672">=</span> raw_data[<span style="color:#ae81ff">52</span>:<span style="color:#ae81ff">68</span>]<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>                    vollog<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;AES IV: </span><span style="color:#e6db74">{</span>aes_iv<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><p>Có thể thấy AES Key ở offset [20:52], AES IV ở offset [52:68] và Agent ID ở [8:12] tại vị trí tìm ra signature.</p>
<p>Do đó, mình nhanh chóng thu được key, iv và agent id từ file dump process.</p>
<p><img alt="image-20241019222043248" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019222043248.png"></p>
<p>Như vậy:</p>
<p><img alt="image-20241019222351896" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019222351896.png"></p>
<p>Thu được:</p>
<pre tabindex="0"><code>agent id:
2a c0 84 1e

aes key: [20:52]
D4 DC 20 98 7E EC 20 02 E0 46 D0 D0 3C BC C2 9A 88 96 44 34 D0 42 90 12 66 BA 98 1C E0 48 98 1E

aes iv: [52:68]
DC DA C0 90 F6 5E A6 76 FC 72 8E 08 54 66 40 30
</code></pre><p>Như vậy, mình đã nghĩ đến đây là xong. Mình chỉ mất khoảng 1 tiếng để tìm được đến đây.</p>
<p>Với bài phân tích vừa rồi, mình đoán sẽ dùng AES decrypt giải mã pcapng để lấy flag.</p>
<p>Tuy nhiên, mọi chuyện không như là mơ.</p>
<h4 id="2-xử-lý-pcapng">2. Xử lý pcapng<a hidden class="anchor" aria-hidden="true" href="#2-xử-lý-pcapng">#</a></h4>
<p>Kiểm tra pcapng thì chỉ thấy có 2 IP 192.168.240.148 và 192.168.240.147.</p>
<p>Kiểm tra thì chỉ có 2 tcpstream là 0 và 1. là các request đến cổng 443 của IP:148. (attacker)</p>
<p>Như vậy, mình cần tìm các requests gửi dữ liệu lên máy chủ, decrypt là lấy được file.</p>
<p>Khó khăn từ đây (do mình dốt crypto :&lt;)</p>
<p>Kiểm tra sơ sơ thì thấy có vài request POST send data rất lớn.</p>
<p><img alt="image-20241019222812163" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019222812163.png"></p>
<p>Đến đây mình dùng Cyberchef để cố decrypt phần body request nhưng thử với tất cả các thuật toán đều không được, về sau phát hiện ra, Havoc dùng <strong>AES CTR mode</strong>.</p>
<p>Tuy nhiên, mình vẫn không decrypt được, mình có thử viết code python decrypt cũng không được. Mãi sau, mình mới đọc lại blog 51cto ở trên. Phát hiện phần body có cấu trúc. 20bytes đầu là các giá trị, sau đó là data bị mã hoá.</p>
<p>Data POST lên có cấu trúc như sau:</p>
<p><img alt="image-20241019223512913" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019223512913.png"></p>
<p>Dó, lúc này mình mới nhận ra và bắt đầu đi lọc các POST request lớn, có Agent ID và check dữ liệu decrypt.</p>
<p>Mình thu được output command, khẳng định AES Key IV là đúng</p>
<p><img alt="image-20241019223631949" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019223631949.png"></p>
<p>Sau đó mình tìm thấy một request có data decrypt có thứ rất quen thuộc, .rels và .xml. Với bản năng của 1 mal analysis, đây là docx mình cần!!!</p>
<p><img alt="image-20241019223758206" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019223758206.png"></p>
<p>Mình thu được file docx sau khi chạy word recovery.</p>
<p><img alt="image-20241019223822777" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019223822777.png"></p>
<p>flag 2:</p>
<pre tabindex="0"><code>Flag2: Th3_9r0unD_0b3y5_m3_0e2845b20c93546}
</code></pre><p>Mình bắt đầu hơi hụt hẫng, ủa flag1 đâu, hay trong request vẫn còn. Mình tiếp tục đi decrypt hết các POST data, thậm chí cả data trả về của Havoc C2 server ở IP:148.</p>
<p>Thu được, đoạn text flagpart1 ????</p>
<p><img alt="image-20241019224000465" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019224000465.png"></p>
<p>Hay một số data có cấu trúc rất lạ, giống kiểu output của ascii graphic, mà mình không đoán ra ý nghĩa</p>
<p><img alt="image-20241019224110338" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019224110338.png"></p>
<p>Data ec0 ec1 do server gửi đến</p>
<p><img alt="image-20241019224140615" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019224140615.png"></p>
<p><img alt="image-20241019224159677" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019224159677.png"></p>
<p>Nohope flag part 1 :&lt;</p>
<p>Sau đó team có tìm thêm 1 số string trong file OneDrive.exe</p>
<p><img alt="image-20241019224232597" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241019224232597.png"></p>
<p>Nhưng có vẻ không khả quan lắm.</p>
<p>Cuối cùng mình định tạo lại lab Havoc nhưng đã quá muộn.</p>
<p>END GAME lần xxx :((((</p>
<hr>
<p>Bonus, phần flagpart1, sau khi có WU của tác giả</p>
<p>Đúng như dự đoán, phần dữ liệu được server gửi đến máy nạn nhân sẽ là 1 object BOF để thực thi,</p>
<p>Hãy quan sát 1 response</p>
<p><img alt="image-20241025091533354" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025091533354.png"></p>
<p>Như trên, khi server response theo cấu trúc chunk, ta sẽ chỉ quan tâm phần Chunk data.</p>
<p>phần Chunk Data này sẽ cấu trúc như sau:</p>
<pre tabindex="0"><code>12 bytes đầu (HEADER) | Sau là data

Trong HEADER: 2 bytes đầu là Command ID (ở Little edians) =&gt; 0x0A00 = 2560 =&gt; BOF objects
</code></pre><p><img alt="image-20241025092132656" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025092132656.png"></p>
<p>Như vậy, decrypt ra sẽ được BOF object.</p>
<p>Tuy nhiên, BOF có signature là bắt đầu bằng bytes</p>
<p><code> 0x64 0x86</code> cho 64 bit và <code>0x4C 0x01</code> (chữ dt và L.) như ảnh (Phần File Header của NTHeader)</p>
<p><img alt="image-20241025095220385" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025095220385.png"></p>
<p>với 32bit</p>
<p><img alt="image-20241025095309081" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025095309081.png"></p>
<p>Thì trong BOF sẽ như này</p>
<p><img alt="image-20241025095352467" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025095352467.png"></p>
<p>Ném vào IDA, phân tích, bấm mặc định, nó sẽ ra được</p>
<p><img alt="image-20241025095431383" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025095431383.png"></p>
<p>Như vậy, sau khi decrypt BOF bằng AES-CTR mode, <em><strong>ta sẽ phải xoá đi 16bytes đầu để bắt đầu bằng signature BOF.</strong></em></p>
<p>Kiểm tra hết các BOF, thấy có BOF để thực thi adduser mà không cần dùng command <code>adduser</code> của windows. Đó là user <code>flagpart1</code></p>
<p>Vì vậy, ta cần đi tìm data của câu lệnh này ở đâu trong BOF object này.</p>
<h5 id="phần-ảo-tìm-data-của-bof-object-này">Phần ảo: Tìm data của BOF object này<a hidden class="anchor" aria-hidden="true" href="#phần-ảo-tìm-data-của-bof-object-này">#</a></h5>
<p>Theo cấu trúc của havoc C2 BOF, thì các BOF sẽ được tạo sẵn , phần data sẽ nối ở phía sau BOF.</p>
<p>Nhưng các thức chúng được mã hoá AES lại khác nhau</p>
<p>như sau:</p>
<pre tabindex="0"><code>DataChunk = 12bytes HEADER + AES-CTF_Encrypt( 16bytes + BOF object ) + DATA_sau_BOF

Mở rộng nhanh, thực tế phần data sau BOF object có 12 bytes là: TaskID, Command,Executable, packed data length nên:

DATA_sau_BOF = 12 bytes + AES-CTF_Encrypt( Dữ liệu parametter của BOF )
</code></pre><p>Nghĩa phần data được mã hoá riêng rẽ chứ không mã hoá chung 1 lần với BOF object.</p>
<p>Mà AES-CTR mode sẽ mã hoá 1bytes thành 1 bytes (tương đương)</p>
<p>Nên chỉ cần lấy độ dài dữ liệu của data chunk post - độ dài  BOF objects sau giải mã - 16bytes đầu</p>
<p>sẽ ra được độ dài phần data bị mã hoá.</p>
<p>Vậy làm sao biết đc BOF object dài bao nhiêu.</p>
<p><a href="https://github.com/HavocFramework/Modules/blob/main/RemoteOps/bin/adduser.x64.o">https://github.com/HavocFramework/Modules/blob/main/RemoteOps/bin/adduser.x64.o</a></p>
<p><strong>Các BOF object là pre-built</strong></p>
<p>Vì vậy, chỉ cần tải file adduser.x64.o cho khớp với BOF trong decrypted data, ta sẽ có được length.</p>
<p><img alt="image-20241025111130741" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025111130741.png"></p>
<p>Ở đây, object BOF Adduser kết thúc ở length 3583, tận cùng là byte 0x00</p>
<p>Vì vậy, với phần data encrypted ở Data chunk</p>
<p><img alt="image-20241025111336351" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025111336351.png"></p>
<p>Phần này cấu trúc như đã nói, toàn bộ <strong>Data Chunk</strong> có length 3776.</p>
<ul>
<li>
<p>Xoá 12bytes đầu header
Được BOF encrypted + data encrypted
Tuy nhiên BOF encrypted này có chứa 16bytes đầu là bytes gì đó, trước khi đến được đoạn signature BOF.</p>
</li>
<li>
<p>Xoá 16bytes đầu của BOF để ra đc signature dt</p>
</li>
<li>
<p>Xoá tiếp 3583 bytes BOF object</p>
</li>
<li>
<p>Ta thu được phần data BOF encrypted.</p>
<p><img alt="image-20241025114037572" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025114037572.png"></p>
<p>Tuy nhiên, phần data BOF encrypted này cũng có cấu trúc là 12 bytes: TaskID, Command,Executable, packed data length rồi mới đến AES-CTR_Encrypted(Data của BOF)</p>
</li>
<li>
<p>Xoá 12 bytes đầu</p>
</li>
<li>
<p>Thực hiện decrypt AES-CTR, Decode UTF-16 LE</p>
</li>
</ul>
<p>Thu được đoạn bytes (153 bytes):</p>
<pre tabindex="0"><code>3b 53 9a a6 93 b6 31 3a cf 25 d6 fa bd b3 ac 98 
69 84 ad 7b 25 94 0e ab 5c 3c ec 4b da ea 98 e8 
5e b5 c2 5a 8e 37 fa f8 83 eb c4 34 c4 d2 9c e0 
67 a6 b5 c0 a3 98 57 3e 29 35 f9 aa 5d 25 1d 44 
4d 3e 8d 15 f8 a0 ba 5b 12 a5 55 55 f4 d9 d4 85 
b7 f4 1d 6d 8d 7b 4a b9 b0 ca 3e 4d 7b 45 75 4d 
ff fd 43 74 34 28 b9 d4 3e 14 1b b3 df 7b b6 7a 
3c 86 23 7f 82 12 04 a7 5e 62 14 00 00 00 13 d0 
c5 8f 13 00 00 00 64 09 97 a7 9e d9 31 8d f7 fd 
4d a6 8d be ad 98 0f 84 ad
</code></pre><p>Decrypt bằng AES-CTR và Decode UTF-16 LE:</p>
<p><img alt="image-20241025134833400" loading="lazy" src="../ascis-2024-forensics-chall-Thugs-on-the-boat_img/image-20241025134833400.png"></p>
<p>Vậy flag1 :</p>
<pre tabindex="0"><code>ASCIS{C@nt_k3Ep_m3_1n_7hE_9r0uNd_
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://qynklee.github.io/tags/re/">RE</a></li>
      <li><a href="https://qynklee.github.io/tags/forensics/">Forensics</a></li>
      <li><a href="https://qynklee.github.io/tags/ctf/">CTF</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://qynklee.github.io/posts/analysis-a-redlinestealer-sample/">
    <span class="title">Next »</span>
    <br>
    <span>Analysis a RedlineStealer Sample</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://qynklee.github.io/">Qynklee in the wild</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
